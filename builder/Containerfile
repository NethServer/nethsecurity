#
# Copyright (C) 2025 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-2.0-only
#

# 2025-06-20
FROM debian:12.11
ARG SOURCE_DATE_EPOCH=1750425039
RUN apt-get update \
    && apt-get install --yes --no-install-recommends --no-install-suggests \
        bison \
        build-essential \
        ca-certificates \
        clang \
        curl \
        file \
        flex \
        g++ \
        gawk \
        gcc-multilib \
        gettext \
        git \
        libncurses5-dev \
        libssl-dev \
        python3-distutils \
        rsync \
        sudo \
        unzip \
        vim \
        wget \
        zlib1g-dev \
    && useradd -m -s '/bin/bash' -U 'buildbot' \
    && echo 'buildbot ALL=(ALL) NOPASSWD: ALL' > /etc/sudoers.d/buildbot

USER buildbot
WORKDIR /home/buildbot
# OpenWRT repo
ARG OWRT_VERSION
ENV OWRT_VERSION=${OWRT_VERSION}
RUN git clone --branch "v${OWRT_VERSION}" --depth 1 https://github.com/openwrt/openwrt.git
WORKDIR /home/buildbot/openwrt
COPY --chown=buildbot:buildbot packages nspackages
COPY --chown=buildbot:buildbot patches patches
COPY --chown=buildbot:buildbot files files
COPY --chown=buildbot:buildbot config config

# Build utils and volumes setup
COPY --chmod=777 builder/setup-build.sh /usr/local/bin/setup-build
COPY --chmod=777 builder/entrypoint.sh /usr/local/bin/entrypoint
ENTRYPOINT ["/usr/local/bin/entrypoint"]
CMD ["/bin/sh", "-c", "make -j$(nproc) world"]
RUN mkdir -p \
      .ccache \
      build_dir \
      dl \
      download \
      staging_dir
VOLUME "/home/buildbot/openwrt/.ccache" \
    "/home/buildbot/openwrt/build_dir" \
    "/home/buildbot/openwrt/dl" \
    "/home/buildbot/openwrt/download" \
    "/home/buildbot/openwrt/staging_dir"
