#!/bin/sh

#
# Copyright (C) 2022 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-2.0-only
#

usage() {
    echo "$0 [-q] [-m oldmac=newmac] <exported_archive> "
    exit 1
}

try_restart() {
    service=$1
    if service "$service" running; then
        echo "service $service restart"
    else
        echo "service $service start"
    fi
}

maps=''
quiet=""

while getopts "qm:" opt
do
    case $opt in
        m) maps="$maps --map ${OPTARG}"  ;;
        q) quiet="--quiet"  ;;
        *) exit 1;;   # DEFAULT
    esac
done

shift $(($OPTIND - 1))
archive=$1

if [ -z "$archive" ]; then
    usage    
fi

if [ ! -f "$archive" ]; then
    echo "No such file or directory: '$1'"
    exit 1
fi


# Prepare target directories and explode archive
tmp_dir=$(mktemp -d)
work_dir=$(pwd)

# Find absolute path of the archive
archive=$(cd "$(dirname -- "$1")" >/dev/null; pwd -P)/$(basename -- "$1")

# Explode the archive
cd $tmp_dir
tar xzf "$archive"
cd $work_dir

# Execute all scripts
for f in $(find /usr/share/ns-migration/ -type f)
do
    if [ -x "$f" ]; then
        "$f" $quiet $maps "$tmp_dir/export"
    fi
done

rm -rf $tmp_dir

# Restart services
service network restart
service firewall restart
service system restart
service ts-ip restart
try_restart dnsmasq
try_restart dropbear
try_restart cron
try_restart sysntpd
try_restart ns-plug
try_restart ts-dns
try_restart openvpn
try_restart mwan3
try_restart swanctl
