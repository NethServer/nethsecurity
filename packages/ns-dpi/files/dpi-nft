#!/bin/sh

#
# Copyright (C) 2025 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-2.0-only
#

#
# DPI: generate NFT script
#

log_opt=""
if [ $(uci -q get dpi.config.log_blocked) = "1" ]; then
    log_opt='log prefix "DPI block: "'
    limit=$(uci -q get firewall.ns_defaults.rule_log_limit)
    # validate limit syntax to avoid error on nft rules
    if echo "$limit" | grep -qE '^[0-9]+/s$'; then
        limit="${limit}econd"
    else
        limit="1/second"
    fi
fi

if nft list chain inet fw4 block_chain >/dev/null 2>&1; then
    echo flush chain inet fw4 block_chain
fi

echo add set inet fw4 nfa.blocks.v4 '{ type ipv4_addr . inet_proto . inet_service . ipv4_addr; size 65536; timeout 15m; }'
echo add chain inet fw4 block_chain '{ type filter hook forward priority -10; }'
if [ -n "$log_opt" ]; then
    echo add rule inet fw4 block_chain ip saddr . ip protocol . th dport . ip daddr @nfa.blocks.v4 limit rate $limit burst 5 packets $log_opt
fi
echo add rule inet fw4 block_chain ip saddr . ip protocol . th dport . ip daddr @nfa.blocks.v4 counter drop
